<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --border: #1e1e2e;
    --accent: #e8ff6b;
    --text: #e8e8f0;
    --muted: #4a4a6a;
    --bubble-in: #1e1e30;
  }

  body {
    background: var(--bg);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'DM Mono', monospace;
    color: var(--text);
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse 60% 50% at 50% 0%, rgba(232,255,107,0.05) 0%, transparent 70%);
    pointer-events: none;
  }

  .role-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 32px;
    animation: rise 0.5s ease both;
  }

  .role-title {
    font-family: 'Syne', sans-serif;
    font-size: 22px;
    font-weight: 800;
    letter-spacing: -0.03em;
    text-align: center;
  }

  .role-subtitle {
    font-size: 12px;
    color: var(--muted);
    margin-top: 6px;
    text-align: center;
  }

  .role-cards { display: flex; gap: 16px; }

  .role-card {
    width: 160px;
    padding: 28px 20px;
    border: 1px solid var(--border);
    border-radius: 18px;
    background: var(--surface);
    cursor: pointer;
    text-align: center;
    transition: border-color 0.2s, transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
    gap: 10px;
    user-select: none;
  }

  .role-card:hover {
    border-color: rgba(232,255,107,0.4);
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
  }

  .role-avatar {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
  }

  .avatar-a { background: rgba(232,255,107,0.12); }
  .avatar-b { background: rgba(107,218,255,0.12); }

  .role-name {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
  }

  .role-name-a { color: var(--accent); }
  .role-name-b { color: #6bdaff; }

  /* â”€â”€ CHAT â”€â”€ */
  .chat-wrapper {
    width: 420px;
    height: 640px;
    display: flex;
    flex-direction: column;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 40px 80px rgba(0,0,0,0.6);
    animation: rise 0.5s cubic-bezier(0.16,1,0.3,1) both;
  }

  @keyframes rise {
    from { opacity: 0; transform: translateY(24px) scale(0.97); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }

  .header {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }

  .avatar-header {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }

  .header-info { flex: 1; }

  .header-name {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 15px;
    letter-spacing: -0.02em;
  }

  .header-status {
    font-size: 11px;
    color: var(--muted);
    margin-top: 2px;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .online-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: #5cff8f;
    box-shadow: 0 0 6px #5cff8f;
  }

  .switch-btn {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .switch-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.15); }

  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 14px 14px 4px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .messages::-webkit-scrollbar { width: 3px; }
  .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    color: var(--muted);
  }

  .empty-icon { font-size: 30px; opacity: 0.3; }
  .empty-text { font-size: 12px; font-style: italic; }

  .msg-row {
    display: flex;
    align-items: flex-end;
    gap: 7px;
    animation: msgIn 0.22s cubic-bezier(0.16,1,0.3,1) both;
  }

  @keyframes msgIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .msg-row.out { flex-direction: row-reverse; }

  .msg-avatar {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    flex-shrink: 0;
  }

  .msg-avatar.hide { opacity: 0; pointer-events: none; }

  .msg-content {
    display: flex;
    flex-direction: column;
    max-width: 72%;
    gap: 2px;
  }

  .msg-row.out .msg-content { align-items: flex-end; }
  .msg-row.in  .msg-content { align-items: flex-start; }

  .bubble {
    padding: 9px 13px;
    border-radius: 18px;
    font-size: 13.5px;
    line-height: 1.5;
    word-break: break-word;
  }

  .msg-row.out .bubble {
    background: linear-gradient(135deg, rgba(232,255,107,0.18), rgba(232,255,107,0.1));
    border: 1px solid rgba(232,255,107,0.22);
    border-bottom-right-radius: 5px;
    color: #d8f060;
  }

  .msg-row.in .bubble {
    background: var(--bubble-in);
    border: 1px solid var(--border);
    border-bottom-left-radius: 5px;
    color: var(--text);
  }

  .msg-row.in.user-b .bubble {
    background: rgba(107,218,255,0.09);
    border-color: rgba(107,218,255,0.18);
    color: #a8e8ff;
  }

  .msg-time {
    font-size: 10px;
    color: var(--muted);
    padding: 0 3px;
  }

  .typing-indicator {
    font-size: 11px;
    color: var(--muted);
    padding: 4px 14px 6px;
    min-height: 22px;
    font-style: italic;
    flex-shrink: 0;
  }

  .input-area {
    padding: 10px 12px 14px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 10px;
    align-items: flex-end;
    flex-shrink: 0;
  }

  textarea {
    flex: 1;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 10px 14px;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    color: var(--text);
    resize: none;
    min-height: 42px;
    max-height: 120px;
    outline: none;
    line-height: 1.5;
    transition: border-color 0.2s;
  }

  textarea::placeholder { color: var(--muted); }
  textarea:focus { border-color: rgba(232,255,107,0.25); }

  .send-btn {
    width: 42px;
    height: 42px;
    border-radius: 12px;
    border: none;
    background: var(--accent);
    color: #0a0a0f;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: transform 0.15s, opacity 0.15s;
    font-size: 18px;
  }

  .send-btn:hover { transform: scale(1.06); }
  .send-btn:active { transform: scale(0.94); }
  .send-btn:disabled { opacity: 0.25; cursor: default; transform: none; }

  .user-b-active .send-btn { background: #6bdaff; }
</style>
</head>
<body>

<!-- Role Selector -->
<div class="role-screen" id="roleScreen">
  <div>
    <div class="role-title">Who are you?</div>
    <div class="role-subtitle">Open in two tabs to chat between users</div>
  </div>
  <div class="role-cards">
    <div class="role-card" onclick="startChat('A')">
      <div class="role-avatar avatar-a">ðŸ‘¤</div>
      <div class="role-name role-name-a">Alex</div>
    </div>
    <div class="role-card" onclick="startChat('B')">
      <div class="role-avatar avatar-b">ðŸ‘¤</div>
      <div class="role-name role-name-b">Jordan</div>
    </div>
  </div>
</div>

<!-- Chat -->
<div class="chat-wrapper" id="chatWrapper" style="display:none;">
  <div class="header">
    <div class="avatar-header" id="headerAvatar"></div>
    <div class="header-info">
      <div class="header-name" id="headerName"></div>
      <div class="header-status">
        <div class="online-dot"></div>
        <span>Online</span>
      </div>
    </div>
    <button class="switch-btn" onclick="switchUser()">Switch user</button>
  </div>

  <div class="messages" id="messages">
    <div class="empty-state" id="emptyState">
      <div class="empty-icon">ðŸ’¬</div>
      <div class="empty-text">No messages yet</div>
    </div>
  </div>

  <div class="typing-indicator" id="typingIndicator"></div>

  <div class="input-area" id="inputArea">
    <textarea id="msgInput" placeholder="Message..." rows="1"></textarea>
    <button class="send-btn" id="sendBtn" disabled>â†‘</button>
  </div>
</div>

<script>
  const USERS = {
    A: { name: 'Alex',   emoji: 'ðŸ‘¤', cls: 'avatar-a' },
    B: { name: 'Jordan', emoji: 'ðŸ‘¤', cls: 'avatar-b' },
  };

  let currentUser = null;
  let messages = [];
  let msgCount = 0;

  const channel = new BroadcastChannel('chat_room_1');
  const STORAGE_KEY = 'chat_msgs_1';

  function startChat(user) {
    currentUser = user;
    document.getElementById('roleScreen').style.display = 'none';
    const wrapper = document.getElementById('chatWrapper');
    wrapper.style.display = 'flex';

    const other = USERS[user === 'A' ? 'B' : 'A'];
    document.getElementById('headerAvatar').className = `avatar-header ${other.cls}`;
    document.getElementById('headerAvatar').textContent = other.emoji;
    document.getElementById('headerName').textContent = other.name;

    if (user === 'B') {
      document.getElementById('inputArea').classList.add('user-b-active');
    }

    loadMessages();
  }

  function switchUser() {
    currentUser = null;
    document.getElementById('chatWrapper').style.display = 'none';
    document.getElementById('roleScreen').style.display = 'flex';
    document.getElementById('inputArea').classList.remove('user-b-active');
    document.getElementById('typingIndicator').textContent = '';
  }

  function loadMessages() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      messages = raw ? JSON.parse(raw) : [];
    } catch { messages = []; }
    renderAll();
  }

  function saveMessages() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  }

  function getTime() {
    return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function escapeHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  function buildRow(m, showAvatar) {
    const isMe = m.sender === currentUser;
    const sender = USERS[m.sender];
    const row = document.createElement('div');
    row.className = `msg-row ${isMe ? 'out' : 'in'}${!isMe && m.sender === 'B' ? ' user-b' : ''}`;
    row.innerHTML = `
      <div class="msg-avatar ${!isMe ? sender.cls : ''} ${isMe || !showAvatar ? 'hide' : ''}">${!isMe && showAvatar ? sender.emoji : ''}</div>
      <div class="msg-content">
        <div class="bubble">${escapeHtml(m.text)}</div>
        <div class="msg-time">${m.time}</div>
      </div>
    `;
    return row;
  }

  function renderAll() {
    const container = document.getElementById('messages');
    document.querySelectorAll('.msg-row').forEach(el => el.remove());

    if (messages.length === 0) {
      document.getElementById('emptyState').style.display = 'flex';
      return;
    }
    document.getElementById('emptyState').style.display = 'none';

    messages.forEach((m, i) => {
      const showAvatar = i === 0 || messages[i-1].sender !== m.sender;
      container.appendChild(buildRow(m, showAvatar));
    });

    container.scrollTop = container.scrollHeight;
  }

  function addRow(m) {
    const container = document.getElementById('messages');
    document.getElementById('emptyState').style.display = 'none';
    const showAvatar = messages.length < 2 || messages[messages.length - 2]?.sender !== m.sender;
    container.appendChild(buildRow(m, showAvatar));
    container.scrollTop = container.scrollHeight;
  }

  // Input
  const inputEl = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');

  inputEl.addEventListener('input', () => {
    sendBtn.disabled = inputEl.value.trim() === '';
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
    channel.postMessage({ type: 'typing', sender: currentUser });
  });

  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); doSend(); }
  });

  sendBtn.addEventListener('click', doSend);

  function doSend() {
    const text = inputEl.value.trim();
    if (!text || !currentUser) return;

    const msg = { sender: currentUser, text, time: getTime(), id: ++msgCount };
    messages.push(msg);
    saveMessages();
    addRow(msg);
    channel.postMessage({ type: 'message', msg });

    inputEl.value = '';
    inputEl.style.height = 'auto';
    sendBtn.disabled = true;
  }

  // Cross-tab communication
  let typingTimer = null;

  channel.addEventListener('message', (e) => {
    if (!currentUser) return;

    if (e.data.type === 'message' && e.data.msg.sender !== currentUser) {
      messages.push(e.data.msg);
      addRow(e.data.msg);
      clearTimeout(typingTimer);
      document.getElementById('typingIndicator').textContent = '';
    }

    if (e.data.type === 'typing' && e.data.sender !== currentUser) {
      const name = USERS[e.data.sender].name;
      document.getElementById('typingIndicator').textContent = `${name} is typing...`;
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        document.getElementById('typingIndicator').textContent = '';
      }, 1500);
    }

    if (e.data.type === 'wipe') {
      messages = [];
      renderAll();
    }
  });

  // Auto-delete on leave â€” silent, no overlay
  function wipeMessages() {
    localStorage.removeItem(STORAGE_KEY);
    channel.postMessage({ type: 'wipe' });
  }

  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') wipeMessages();
  });
  window.addEventListener('beforeunload', wipeMessages);
  window.addEventListener('pagehide', wipeMessages);
</script>
</body>
</html>
